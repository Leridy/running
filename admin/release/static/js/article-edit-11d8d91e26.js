$(function(){var t={form:$("#form")},e={id:System.getParam("id")||0,filters:{picture:[{title:"jpg files",extensions:"jpg"},{title:"jpg files",extensions:"jpeg"},{title:"jpg files",extensions:"png"}]},formData:{cover:"",tags:[]}},o={init:function(){$.when(this.loadConfig()).done(function(){e.id?($("#title").html("修改文章"),this.getData(e.id).done(function(a){0==a.res&&(e.formData=$.extend(e.formData,a.data[0]),e.formData.tags=e.formData.tags.split("|"),e.formData.content=decodeURIComponent(e.formData.content),t.form.html(System.template("appTpl",{info:e.formData,tagList:e.tagList})),o.bindEvents())})):(t.form.html(System.template("appTpl",{info:{tags:[]},tagList:e.tagList})),this.bindEvents(),$("#title").html("新增文章"))}.bind(this))},initNodes:function(){$.extend(t,{wrapper:$("#wrapper"),prviewImg:$("#prview-img"),submit:$("#submit"),modalImgCropper:$("#modal-img-cropper"),CropperImg:$("#cropper-img"),showPickfileBtn:$('[data-action="showpickfile"]'),modalReplySure:$("#modal-reply-sure"),modalSetSize:$("#modal-set-size"),$dataX:$("#dataX"),$dataY:$("#dataY"),$dataHeight:$("#dataHeight"),$dataWidth:$("#dataWidth"),modalJustUpload:$("#modal-just-upload")})},bindEvents:function(){this.initNodes(),this.formUpload(),t.form.on("submit",this.handleSubmit),window.ue=UE.getEditor("content"),t.showPickfileBtn.on("click",this.handleShowPickFile),t.modalReplySure.on("click",this.handleReplySure),t.CropperImg.on("load",this.handleCropperImgLoad),t.modalJustUpload.on("click",this.handleJustUpload),t.form.on("click",'[data-action="tag"]',this.handleTagClick)},handleTagClick:function(){var t=$(this),o=t.text(),a=e.formData.tags;t.hasClass("btn-info")?(t.removeClass("btn-info"),a.contains(o)&&a.remove(o)):(t.addClass("btn-info"),a.contains(o)||a.push(o)),e.formData.tags=a},handleCropperImgLoad:function(){t.CropperImg.cropper({aspectRatio:1,data:{x:420,y:50,width:640,height:360},preview:".preview",done:function(e){t.$dataX.val(e.x),t.$dataY.val(e.y),t.$dataHeight.val(e.height),t.$dataWidth.val(e.width)},build:function(t){},built:function(t){},dragstart:function(t){},dragmove:function(t){},dragend:function(t){}})},handleSubmit:function(o){o.preventDefault();var a=t.form.serializeObject();return 0==e.formData.tags.length?void $.toast({icon:"error",text:"请选择标签"}):(a.tags=e.formData.tags.join("|"),a.title?(a.cover=e.formData.cover,a.id=e.id,a.content?(a.content=encodeURIComponent(a.content),a.desc?(t.submit.prop("disabled",!0),System.request({type:"POST",url:"manage/edit_article",data:a}).done(function(t){0==t.res?($.toast({icon:"success",text:a.id?"恭喜您修改成功":"恭喜您发布成功"}),setTimeout(function(){System.redirect("/pages/article-list.html")},800)):$.toast({icon:"error",text:t.msg})}).fail(function(){$.toast({icon:"error",text:"网络错误"})}).always(function(){t.submit.prop("disabled",!1)})):void $.toast({icon:"error",text:"请输入摘要"})):void $.toast({icon:"error",text:"请输入内容"})):void $.toast({icon:"error",text:"请输入标题"}))},handleReplySure:function(){var o=t.CropperImg.cropper("getData",!0),a=e.formData.cover;o.width&&a&&(a.indexOf("?imageMogr2")==-1?a+="?imageMogr2/crop/!%sx%sa%sa%s".printf(o.width,o.height,o.x,o.y):(a=a.substring(0,a.indexOf("?")),a+="?imageMogr2/crop/!%sx%sa%sa%s".printf(o.width,o.height,o.x,o.y))),e.formData.cover=a,t.prviewImg.attr("src",a),t.modalImgCropper.modal("hide")},handleJustUpload:function(){var o=t.CropperImg.cropper("getData",!0);e.formData.cover=o,t.prviewImg.attr("src",o),t.modalImgCropper.modal("hide")},handleShowPickFile:function(e){e.preventDefault(),t.modalImgCropper.modal("show"),t.CropperImg.attr("src")&&(t.CropperImg.cropper("destroy"),o.initImgCropper())},getData:function(t){return System.request({type:"get",url:"manage/get_article",data:{id:t}}).done(function(t){0!=t.res&&$.toast({icon:"error",text:t.msg})}).fail(function(){$.toast({icon:"error",text:"网络错误"})})},loadConfig:function(){return System.request({type:"GET",url:"manage/get_article_tag_list",data:$.extend(e.filter,{begin:0,limit:100})}).done(function(t){0==t.res?e.tagList=t.data:$.toast({icon:"error",text:t.msg})})},formUpload:function(){var o=null,a=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"upload-photo",uptoken_func:function(t){var e=null;return System.request({type:"GET",async:!1,data:{},url:"utils/get_upload_token"}).done(function(t){e=t.data}),e},filters:e.filters.picture,get_new_uptoken:!0,domain:"<Your bucket domain>",container:"container",max_file_size:"100mb",flash_swf_url:"/static/bower_components/plupload/js/Moxie.swf",max_retries:0,dragdrop:!0,drop_element:"container",auto_start:!0,multi_selection:!0,init:{FilesAdded:function(t,e){plupload.each(e,function(t){})},BeforeUpload:function(t,e){var a=t.getOption("browse_button")[0];a.disabled=!0,o||(o=a.innerHTML)},UploadProgress:function(t,e){var o=t.getOption("browse_button")[0];o.innerHTML="已上传%s%".printf(e.percent)},FileUploaded:function(a,r,i){var n=$.parseJSON(i);btn=a.getOption("browse_button")[0],t.CropperImg.attr("src")&&t.CropperImg.cropper("destroy"),t.CropperImg.attr("src",n.url),e.formData.cover=n.url,btn.innerHTML=o,btn.disabled=!1},Error:function(t,e,a){var r=$.parseJSON(e.response),i=t.getOption("browse_button")[0];$.toast({icon:"error",text:r.error}),i.disabled=!1,i.innerHTML=o},UploadComplete:function(){},Key:function(t,e){var o=void 0;return o}}});e.uploader=a}};o.init()});